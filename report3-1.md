# 課題 (パッチパネルの機能拡張) レポート

##課題内容

パッチパネルに機能を追加しよう。

授業で説明したパッチの追加と削除以外に、以下の機能をパッチパネルに追加してください。

1. ポートのミラーリング
2. パッチとポートミラーリングの一覧

それぞれ patch_panel のサブコマンドとして実装してください。

##方針

パッチの追加と削除を実行するコマンドは /bin/patch_panel に記述されている。このファイルに以下のコマンドの記述を追加した。

<dl>
	<dt>mirror [dpid] [port1] [port2] </dt>
	<dd>ID dpid のスイッチに対して、port1 をミラーリング元、port2 をミラーリング先としたミラーを設定する（課題の機能 1. に相当）。</dd> 
	<dt>list [dpid] </dt>
	<dd>ID dpid のスイッチに設定されている、パッチとポートミラーリングの一覧を表示する（課題の機能 2. に相当）。</dd>
</dl>

続いて、これらのコマンドの実装について説明する。

##mirror コマンド

mirror コマンドは、 /lib/patch_panel.rb の create_mirror メソッドを呼び出している。このメソッドでは以下の2つのことを行っている。

1. 求めるミラーリングを実現するためのフローエントリをスイッチに追加する。
2. スイッチの持つミラーリングのリストに、今回追加したミラーを追加する。

1番めの操作は、add_mirror_entries メソッドで実現している。ここではまずスイッチの持つパッチのリストを参照し、ミラーリング元のポート（port_a）とパッチで接続しているポート（port_c）を検索する。port_c が見つかったなら、 delete_flow_entries メソッドで port_a と port_c をパッチでつなぐためのフローエントリを削除し、新たに次の内容のフローエントリを追加する。

* port_a から入ってきたパケットを port_b （ミラーリング先のポート）
と port_c へ転送する。
* port_c から入ってきたパケットを port_a と port_b へ転送する。

この２つのフローエントリによって、port_a と port_c をつなぐパッチを作成すると共に、このパッチで送受信されるパケットを port_b へ転送する、すなわち port_b へのパケットのミラーリングを実現できる。続いて、スイッチは起動時にミラーリングのリストとしてハッシュテーブル　@mirror を生成しており、ここに port_a と port_b の組を登録することで、2番目の操作を実現している。

##list コマンド

list コマンドは、 /lib/patch_panel.rb の show_list メソッドを呼び出している。ここでは、スイッチの持つパッチのテーブル (@patch) とミラーリングのテーブル (@mirror) を参照し、各要素を順番にターミナルに出力している。
